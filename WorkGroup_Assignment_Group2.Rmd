---
title: "Air quality in Madrid"
subtitle: "An analysis of pollutants trends in the city of Madrid from 2011 to 2016"
author: "Group 2"
date: "12/17/2017"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r lib loading, include=FALSE}

library(data.table) #package to deal with data tables
library(readxl) #package to read excel files
library(tidyr) #package to reshape data
library(ggplot2)
library(gridExtra)
library(corrplot)
library(plotly)
library(shiny)
library(dygraphs)
library(leaflet)
library(viridis)
```
## Introduction

INSERT INTRODUCTION

## Importing the initial datasets
The analysis is based in two main datasets, one containing information about tha pollutant parameters, measured at an hourly level in 24 different stations and the other conntaining information about the weather at a daily level

#### Importing the pollutants observations
The observations on pollutants are stored in 72 `.csv` files, each containing the hourly levels of all the parameter for 1 single month. The following function automate the process of reading all the `.csv` files and stores the observations in the initial `raw_data` dataset.

```{r raw_data, results=FALSE}
years <- c(11:12); months <- c(1:12)
filenameprefix <- "hourly_data"
raw_data <- data.table(year=integer(), month=integer(), day=character(), hour=integer(),station=integer(), parameter=integer(), value=numeric())

sapply(years, function(x) { sapply(months, function(y) {
  filename <- paste(paste(filenameprefix, as.character(x), as.character(y), sep="_"), '.csv', sep='')
  df <- read.csv(filename)
  yr <- rep(x+2000, nrow(df)); mnth <- rep(y, nrow(df)); dftemp <- data.frame(year=yr, month=mnth)
  df <- cbind(dftemp, df); raw_data <<- rbind(raw_data, df)
}) })
```

Taking an initial look at raw_data:
```{r raw_data initial look}
head(raw_data)
str(raw_data)
```

Converting NA values to zeros
```{r raw_data NA <- 0, results=FALSE}
raw_data[is.na(value), 'value'] <- 0
```

#### Importing the weather records
Weather records are store in an excel file. After importing the observations, the date column is converted in date format.
```{r reading weather, results=FALSE}
weather <- data.table(read_excel("weather.xlsx"))
weather$date <- as.Date(weather$date)
```

Taking an initial look at weather:
```{r weather initial look}
head(weather)
str(weather)
```

#### Importing additional datasets
Other than the two main datasets, some other informations might be useful during the analysis. Three additional dataset are therfore loaded:

- `parameters` is a dataset that contains information to relate the parameter ID in `raw_data` with parameter name, formula, unit, ecc..

- `stations` is a dataset that contains information to relate the station ID in `raw_data` with station name, latitude, longitude, type, ecc...

- `holidays` is a list of holidays in Madrid from 2011 to 2016

```{r other datasets, results=FALSE}
#Reading parameters info
parameters <- data.table(read.csv("parameters.csv"))

#Reading stations info
stations <- data.table(read.csv("stations.csv"))

#Reading holidays list and converting to date format
holidays <- (data.table(read.csv("holidays.csv")))
holidays$holiday <- as.Date(holidays$holiday)
```

Taking an initial look at the newly imported datasets:
```{r other datasets initial look}
str(parameters)
str(stations)
str(holidays)
```

## Data transformation
Once the data are all important, the next step is to apply some transformation and create some new variables to accomodate the needs of the analysis.

#### Creating a new dataset `h_data`
This first transformation create a new dataset `h_data` from `raw_data`, adding a new column `ob_date` by pasting togheter information from `year`, `month` and `day` columns in a format that matches the date format in the `data` column of `weather` dataset. The format of the column is automatically converted to date during import.

```{r date raw_data}
h_data <- raw_data[ ,ob_date := as.Date(paste0(year,"-",month,"-",day))]
h_data <- merge(h_data, parameters, by.x="parameter", by.y="param_ID", all = FALSE)
h_data <- merge(h_data, stations, by.x="station", by.y="station_ID", all=FALSE)
head(h_data)

```

#### Subsetting `h_data` to create a daily dataset `daily_data` and merge it with other datasets

The following step create a new dataset `daily_data` with daily obesrvation, averaging the hourly value of every parameter  

``` {r daily data creation}
daily_data <- h_data[,.(daily_avg=mean(value)), by=.(ob_date,station,parameter)]
```

The newly created dataset is then merged with an inner join to `weather`dataset.

``` {r merging with weather and so on}
daily_data <- merge(daily_data, weather, by.x="ob_date", by.y="date", all=FALSE)
daily_data <- merge(daily_data, parameters, by.x="parameter", by.y="param_ID", all = FALSE)
daily_data <- merge(daily_data, stations, by.x="station", by.y="station_ID", all=FALSE)
head(daily_data)
```

Let's now add some information about the days of the week,
```{r day of the week}
daily_data[ ,week_day:=weekdays(ob_date)]
```

And create dummy variables for workdays and restdays.
```{r dummy days}
daily_data[ ,restday := ((daily_data$week_day %in% c("Saturday", "Sunday")) | (daily_data$ob_date %in% holidays$holiday)) ]
daily_data[ ,workday := !(daily_data$restday)]

head(daily_data)
```

The next transformation expand the parameter column into many, each one for a different parameter:
```{r many columns}
daily_data_pp <- daily_data
daily_data_pp <- daily_data_pp[ ,c("param_Name", "param_unit", "parameter") := NULL]
daily_data_pp <- data.table(tidyr::spread(daily_data_pp, param_Form, daily_avg))
str(daily_data_pp)
```


## Data exploration

Prior to the exploration of the data, it is useful to understand some scientific facts about the pollutants 

#### Single variable analysis on NO2

```{r NO2}
NO2 <- daily_data_pp$NO2[!is.na(daily_data_pp$NO2)]
quantile(NO2, seq(0,1,0.1))
```

```{r NO2plot, results='hide'}
p0_NO2<-qplot(x=1:length(NO2),y=NO2, geom='point')
p1_NO2<-qplot(NO2, geom='histogram')
p2_NO2<-qplot(NO2, geom='density')
p3_NO2<-qplot(NO2, x= 1, geom = "boxplot")
p_NO2<-list(p0_NO2,p1_NO2, p2_NO2, p3_NO2)

marrangeGrob(p_NO2, nrow=2, ncol=2)
```

```{r NO2mean}
NO2_mean <- mean(NO2)
NO2_sd <- sd(NO2)

NO2_mean
NO2_sd
```

```{r NO2 col}
plot(NO2, pch=19, xlab=''); grid()
abline(50,0,col="chartreuse4")  
abline(100,0,col="gold") 
abline(150,0,col="darkorange2")
points(rep(0,length(NO2)),col='white')
```

#### Correlation plots

```{r corrp1}
corrplot(cor(daily_data_pp[complete.cases(daily_data_pp), c("BEN","CO","EBE","NMHC","NO","NO2","O3","PM10","PM2.5","SO2","TCH","TOL")]), method = 'number', tl.col = 'black', order='hclust')
```

```{r coorplot2}
corrplot(cor(daily_data_pp[complete.cases(daily_data_pp), c("temp_avg", "humidity", "wind_avg_speed", "precipitation", "NO2", "O3")]), method = 'number', tl.col = 'black', order='hclust')
```

```{r trial4, echo=FALSE}


shinyApp(

options=list(width="100%", height=1000),

ui <- shinyUI(fluidPage(
  titlePanel("Pollution heatmap"),

  fluidRow(
    column(width = 3,
           helpText("Select a pollutant"),
           selectInput("pollutant", label = "Pollutant",
                       choices = parameters$param_Form, selected = 1)
    ),
    #column(width = 1),
    column(width = 3,
           helpText("Select a station"),
           selectInput("station", label = "Station",
                       choices = stations$station_Name, selected = 28079004)
    ),
    column(width = 3,
           helpText("Select a year"),
           selectInput("year", label = "Year",
                       choices = unique(h_data$year),
                       selected = 2011)
    )

  ),

  plotOutput("heatmap", width = "100%", height = 700)
)
),

server <- shinyServer(function(input,output) {



  output$heatmap = renderPlot({
      df <- subset(h_data, year == input$year & station_Name == input$station & param_Form == input$pollutant, c("day", "month", "year", "hour", "value"))
    library(ggplot2)
    library(dplyr) # easier data wrangling
    library(viridis) # colour blind friendly palette, works in B&W also
    #library(Interpol.T) #  will generate a large dataset on initial load
    library(lubridate) # for easy date manipulation
    library(ggExtra) # because remembering ggplot theme options is beyond me
    library(tidyr)


    df$day <- as.numeric(df$day)
    df$hour <- as.numeric(df$hour)
    df$month <- as.numeric(df$month)
    df$year <- as.numeric(df$year)
    df$value <- as.numeric(df$value)
    plot(ggplot(df,aes(day,hour,fill=as.numeric(value))) + geom_tile(color= "white",size=0.1)
         + scale_fill_viridis(name="Hourly Value (microg/m^3)  ",option ="C")
         + facet_grid(year~month)
         + scale_y_continuous(trans = "reverse", breaks = unique(df$hour))
         + scale_x_continuous(breaks =c(1,10,20,31))
         + theme_minimal(base_size = 8)
         + labs(title= paste("Hourly Pollution values - Station", input$station), x="Day", y="Hour")
         + theme(legend.position = "bottom")+
           theme(plot.title=element_text(size = 14))+
           theme(axis.text.y=element_text(size=6)) +
           theme(strip.background = element_rect(colour="white"))+
           theme(plot.title=element_text(hjust=0))+
           theme(axis.ticks=element_blank())+
           theme(axis.text=element_text(size=7))+
           theme(legend.title=element_text(size=8))+
           theme(legend.text=element_text(size=6))+
           removeGrid())

  })
})
)

```

```{r trial3, echo=FALSE}

library(shiny)

shinyApp(

options=list(width="100%", height=1000),

ui <- shinyUI(fluidPage(
  titlePanel("Pollution map"),

  fluidRow(
    column(width = 3,
           helpText("Select a pollutant"),
           selectInput("pollutant", label = "Pollutant",
                       choices = parameters$param_Form, selected = 1)
    ),

    column(width = 3,
           helpText("Select a day"),
           dateInput("date", label = "Day", value = "2011-01-01", min = "2011-01-01", max = "2012-12-31",
                     format = "yyyy-mm-dd")

    )

  ),

  leafletOutput("map", width = "100%", height = 500)
)
),

server <- shinyServer(function(input,output) {
  output$map = renderLeaflet({

    library(leaflet)

    # load example data (Fiji Earthquakes) + keep only 100 first lines
    map_data = subset(daily_data, ob_date == input$date & param_Form == input$pollutant, c("Lng", "Lat", "temp_avg", "station_Name", "Alt", "Type", "daily_avg"))
    min_v <- min(map_data$daily_avg)
    max_v <- max(map_data$daily_avg)

    # Create a color palette with handmade bins.
    mybins=seq(min_v, max_v, by=(max_v-min_v)/9)
    mypalette = colorBin( palette="YlOrRd", domain=map_data$daily_avg, na.color="black", bins=mybins)

    # Prepar the text for the tooltip:
    mytext=paste("Station: ", map_data$station_Name, "<br/>", paste0(input$pollutant, " value (microg/m^3): "), round(map_data$daily_avg, 1), "<br/>", "Temperature: ", map_data$temp_avg, "<br/>", "Altitude: ", map_data$Alt, "<br/>", "Station Type: ", map_data$Type, sep="") %>%
      lapply(htmltools::HTML)

    # Final Map
    style <- providers$Stamen.Toner
    leaflet(map_data) %>%

      addTiles() %>%

      #clearBounds()
      fitBounds(map_data$Lng[22],map_data$Lat[22],map_data$Lng[8],map_data$Lat[5]) %>%
      addProviderTiles("Esri.WorldImagery") %>%
      addProviderTiles(providers$Esri.WorldGrayCanvas) %>% addProviderTiles(providers$Stamen.TonerLabels) %>%
      addProviderTiles(providers$Stamen.TonerLines,options = providerTileOptions(opacity = 0.35)) %>%
      addCircleMarkers(~Lng, ~Lat,
                       fillColor = ~mypalette(daily_avg), fillOpacity = 0.7, color="white", radius=25, stroke=F,
                       label = mytext,
                       labelOptions = labelOptions( style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "13px", direction = "auto")
      ) %>%
      addLegend( pal=mypalette, values=~daily_avg, opacity=0.9, title = paste0(input$pollutant, " (microg/m^3)"), position = "bottomright" )

  })
})
)

```

```{r trial, echo=FALSE}

library(shiny)

shinyApp(

options=list(width="100%", height=1000),

ui <- shinyUI(fluidPage(
  titlePanel("Time series"),

  fluidRow(
    column(width = 3,
           helpText("Select a pollutant"),
           selectInput("pollutant1", label = "Pollutant",
                       choices = parameters$param_Form, selected = 1)
    ),

    column(width = 3,
           helpText("Select a pollutant"),
           selectInput("pollutant2", label = "Pollutant",
                       choices = parameters$param_Form, selected = 1)
    )

  ),

  dygraphOutput("timeseries", width = "100%", height = 700)
)
),

server <- shinyServer(function(input,output) {
  output$timeseries = renderDygraph({

    library(dygraphs)
    library(tidyverse)
    library(lubridate)

    ts1 <- daily_data_pp

    ts1 <- ts1[complete.cases(ts1), ]

    ts1 <- subset(ts1, select = c("ob_date", input$pollutant1,input$pollutant2))

    dygraph(ts1) %>%
      dyAxis("y") %>%
      dyAxis('y2') %>%
      dySeries(input$pollutant1, axis = "y", label = input$pollutant1)  %>%
      dySeries(input$pollutant2, axis = "y2", label = input$pollutant2)  %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector()

  })
})
)

```

```{r trial1, echo=FALSE}

library(shiny)

shinyApp(

options=list(width="100%", height=1000),

ui <- shinyUI(fluidPage(
  titlePanel("Time series"),

  fluidRow(
    column(width = 3,
           helpText("Select a pollutant"),
           selectInput("pollutant", label = "Pollutant",
                       choices = parameters$param_Form, selected = 1)
    ),

    column(width = 3,
           helpText("Select a pollutant"),
           selectInput("weather", label = "Weather",
                       choices = colnames(weather), selected = "wind_avg_speed")
    )

  ),

  dygraphOutput("timeseries2", width = "100%", height = 700)
)
),

server <- shinyServer(function(input,output) {
  output$timeseries2 = renderDygraph({

    library(dygraphs)
    library(tidyverse)
    library(lubridate)

    ts2 <- daily_data_pp
    ts2 <- ts2[complete.cases(ts2), ]

    ts2 <- subset(ts2, select = c("ob_date", input$pollutant,input$weather))

    dygraph(ts2) %>%
      dyAxis("y") %>%
      dyAxis('y2') %>%
      dySeries(input$pollutant, axis = "y", label = input$pollutant)  %>%
      dySeries(input$weather, axis = "y2", label = input$weather)  %>%
      dyOptions(stackedGraph = TRUE) %>%
      dyRangeSelector()

  })
})
)
```

